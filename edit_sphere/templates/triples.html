{% macro render_triple(triple, subject) %}
    <li class="list-group-item d-flex align-items-center">
        <span class="flex-grow-1 d-flex flex-column justify-content-center p-3 w-75">
            <span class="ellipsis" title="{{triple['predicate']['value']}}">
                <a class="fw-bold"href="{{ (triple['predicate']['value'] | split_ns)[0][:-1] }}#{{ triple['predicate']['value'] }}" target="_blank" alt="Definition of the property {{ triple['predicate']['value'] }}">
                    {{ triple['predicate']['value'] | human_readable_predicate }}
                    <i class="bi bi-question-circle ml-1"></i>
                </a>
            </span>
            {% if triple['object']['value'] != triple['object']['value'] | human_readable_predicate %}
                <span title="{{ triple['object']['value'] }}" class="object-value mt-4 ellipsis">
                    <a href="{{ (triple['object']['value'] | split_ns)[0][:-1] }}#{{ triple['object']['value'] }}" target="_blank" alt="Definition of the value {{ triple['object']['value'] }}">
                        {{ triple['object']['value'] | human_readable_predicate }}
                        <i class="bi bi-question-circle ml-1"></i>
                    </a>
                </span>
            {% elif triple['object']['value'].startswith('http://') or triple['object']['value'].startswith('https://') %}
                <span title="{{ triple['object']['value'] }}" class="object-value mt-4 ellipsis">
                    <a href="{{url_for('show_triples', subject=triple['object']['value']|urlencode)}}" alt="Link to the entity {{ triple['object']['value'] }}">{{ triple['object']['value'] }}</a>
                </span>
            {% else %}
                <span title="{{ triple['object']['value'] }}" class="object-value mt-4 ellipsis">{{ triple['object']['value'] }}</span>
            {% endif %}
            <form class="edit-form d-none"
                action="{{ url_for('update_triple') }}"
                method="post">
                <input type="hidden" name="subject" value="{{ subject }}">
                <input type="hidden" name="predicate" value="{{ triple['predicate']['value'] }}">
                <input type="hidden" name="old_value" value="{{ triple['object']['value'] }}">
                <input type="text" class="form-control my-4" name="new_value" value="{{ triple['object']['value'] }}">
                <div>
                    <button type="submit" class="btn btn-primary">{{_('Update')}}</button>
                    <button type="button" class="btn btn-secondary cancel-button">{{_('Cancel')}}</button>
                </div>
            </form>
        </span>
        <div class="align-self-start">
            <div class="d-flex flex-column flex-sm-row">
                <button class="btn btn-outline-secondary edit-button m-2">
                    <i class="bi bi-pencil-square"></i> <!-- Icona di modifica -->
                </button>    
                <button class="btn btn-outline-danger delete-button m-2" data-subject="{{ subject }}" data-predicate="{{ triple['predicate']['value'] }}" data-object="{{ triple['object']['value'] }}">
                    <i class="bi bi-trash"></i> <!-- Icona di cancellazione -->
                </button>                    
            </div>
        </div>
    </li>
{% endmacro %}

{% extends "_base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 ellipsis">{{_('About')}} {{ subject | human_readable_predicate }}</h2>

    <a href="{{ url_for('entity_history', entity_uri=subject) }}" class="btn btn-outline-primary">
        <i class="bi bi-clock-history"></i> {{_('Time machine')}}
    </a>
    
    {% if triples %}

        {% set attributes_triples = [] %}
        {% set links_triples = [] %}
        {% for triple in triples %}
            {% if triple['object']['value'] != triple['object']['value'] | human_readable_predicate or not (triple['object']['value'].startswith('http://') or triple['object']['value'].startswith('https://')) %}
                {% set _ = attributes_triples.append(triple) %}
            {% elif triple['object']['value'] == triple['object']['value'] | human_readable_predicate and (triple['object']['value'].startswith('http://') or triple['object']['value'].startswith('https://')) %}
                {% set _ = links_triples.append(triple) %}
            {% endif %}
        {% endfor %}
    
        {% if attributes_triples %}
            <h4 class="mt-5 mb-3">{{_('Attributes')}}</h4>
            <ul class="list-group">
                {% for triple in attributes_triples  %}
                    {{ render_triple(triple, subject) }}
                {% endfor %}
            </ul>
        {% endif %}
        {% if links_triples %}
            <h4 class="mt-5 mb-3">{{_('Links to other resources')}}</h4> 
            <ul class="list-group">
                {% for triple in links_triples %}
                    {{ render_triple(triple, subject) }}
                {% endfor %}
            </ul>
        {% endif %}
    {% else %}
        <p class="alert alert-warning">{{_('There is no information related to this entity in the dataset')}}</p>
    {% endif %}
</div>

<script>
    $(document).ready(function () {
        function toggleEditForm(listItem) {
            const form = listItem.find('.edit-form');
            const valueSpan = listItem.find('.object-value');
            form.toggleClass('d-none');
            valueSpan.toggleClass('d-none');
        }

        $('.edit-button').click(function () {
            toggleEditForm($(this).closest('.list-group-item'));
        });

        $('.cancel-button').click(function () {
            toggleEditForm($(this).closest('.list-group-item'));
        });

        $('.delete-button').click(function() {
            const subject = $(this).data('subject');
            const predicate = $(this).data('predicate');
            const object_value = $(this).data('object');
            
            Swal.fire({
                title: "{{_('Are you sure?')}}",
                text: "{{_('You are about to delete this information. In any case, it will be possible to restore it')}}",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: "{{_('Yes, delete it!')}}"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/delete_triple', {
                        subject: subject,
                        predicate: predicate,
                        object: object_value
                    }, function() {
                        Swal.fire(
                            "{{_('Deleted!')}}",
                            "{{_('The data was deleted correctly')}}",
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    });
                }
            });
        });
    });
</script>
{% endblock %}